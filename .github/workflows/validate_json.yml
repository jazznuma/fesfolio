name: Validate Event JSON

on:
  pull_request:
    paths:
      - 'events/**/*.json'
  push:
    branches:
      - main
    paths:
      - 'events/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install AJV (JSON Schema validator)
        run: npm install -g ajv-cli
      
      - name: Validate JSON files
        run: |
          echo "Validating JSON files against schema..."
          find events -name "*.json" -type f | while read file; do
            echo "Validating: $file"
            ajv validate -s schemas/event.schema.json -d "$file" --strict=false
            if [ $? -ne 0 ]; then
              echo "‚ùå Validation failed for $file"
              exit 1
            else
              echo "‚úÖ $file is valid"
            fi
          done
      
      - name: Check file naming convention
        run: |
          echo "Checking file naming convention..."
          find events -name "*.json" -type f | while read file; do
            filename=$(basename "$file")
            if [[ ! $filename =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}_[a-z]_[a-z0-9-]+\.json$ ]]; then
              echo "‚ùå Invalid filename: $filename"
              echo "Expected format: YYYY-MM-DD_category_slug.json"
              exit 1
            fi
          done
          echo "‚úÖ All filenames are valid"
      
      - name: Validation Summary
        if: success()
        run: |
          echo "üéâ All JSON files are valid!"
